<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PhotoSat Map Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

  <style>
    html, body, #map {
      height: 100vh;
      margin: 0;
      padding: 0;
    }

    .leaflet-bar a,
    .leaflet-control-custom {
      background-color: #fff;
      width: 30px;
      height: 30px;
      line-height: 30px;
      display: block;
      text-align: center;
      text-decoration: none;
      color: black;
      font-size: 18px;
      border-bottom: 1px solid #ccc;
    }

    .leaflet-bar a:last-child,
    .leaflet-control-custom:last-child {
      border-bottom: none;
    }

    .leaflet-bar a:hover,
    .leaflet-control-custom:hover {
      background-color: #f0f0f0;
    }

    .leaflet-control-custom {
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .leaflet-bar a,
      .leaflet-control-custom {
        width: 36px;
        height: 36px;
        line-height: 36px;
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    var initialView = {
      center: [67.0646, 20.8409],
      zoom: 13
    };

    var map = L.map('map').setView(initialView.center, initialView.zoom);

    // Base map
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Custom tiles
    L.tileLayer('https://jgarciapelayo.github.io/Tiles/NewTilesTest/{z}/{x}/{y}.png', {
      minZoom: 12,
      maxZoom: 17,
      opacity: 1,
      attribution: 'PhotoSat Custom Tiles'
    }).addTo(map);

    // Location toggle
    var locationCircle = null;

    function toggleLocation() {
      if (locationCircle) {
        map.removeLayer(locationCircle);
        locationCircle = null;
        return;
      }

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          var lat = position.coords.latitude;
          var lng = position.coords.longitude;

          locationCircle = L.circleMarker([lat, lng], {
            radius: 6,
            color: 'white',
            weight: 2,
            fillColor: 'blue',
            fillOpacity: 1
          }).addTo(map);

          map.setView([lat, lng], 14.5);
        }, function (error) {
          console.error("Error getting location:", error.message);
        });
      } else {
        alert("Geolocation not supported by this browser.");
      }
    }

    function recenterMap() {
      map.setView(initialView.center, initialView.zoom);
    }

    // SENSOR toggle from CSV
    let sensorLayer = null;

    function toggleSensors() {
      if (sensorLayer) {
        map.removeLayer(sensorLayer);
        sensorLayer = null;
        return;
      }

      fetch('AitikSensors.csv')
        .then(response => response.text())
        .then(csvText => {
          const rows = csvText.trim().split('\n').slice(1);
          const features = rows.map(row => {
            const [name, lat, lon] = row.split(',');
            return L.circleMarker([parseFloat(lat), parseFloat(lon)], {
  radius: 5,
  color: 'red',
  fillColor: 'red',
  fillOpacity: 1,
  weight: 0
}).bindPopup(`<b>${name}</b>`);
          });
          sensorLayer = L.layerGroup(features).addTo(map);
        })
        .catch(err => {
          console.error("Error loading CSV:", err);
          alert("Could not load sensors from CSV.");
        });
    }

    // Custom controls
    var LocationControl = L.Control.extend({
      options: { position: 'topleft' },
      onAdd: function () {
        var container = L.DomUtil.create('a', 'leaflet-control-custom');
        container.innerHTML = 'üìç';
        container.title = "Show My Location";
        container.href = "#";
        container.onclick = function (e) {
          e.preventDefault();
          toggleLocation();
        };
        return container;
      }
    });

    var RecenterControl = L.Control.extend({
      options: { position: 'topleft' },
      onAdd: function () {
        var container = L.DomUtil.create('a', 'leaflet-control-custom');
        container.innerHTML = 'üîÑ';
        container.title = "Recenter Map";
        container.href = "#";
        container.onclick = function (e) {
          e.preventDefault();
          recenterMap();
        };
        return container;
      }
    });

    var SensorControl = L.Control.extend({
      options: { position: 'topleft' },
      onAdd: function () {
        var container = L.DomUtil.create('a', 'leaflet-control-custom');
        container.innerHTML = 'üì°';
        container.title = "Toggle Sensors";
        container.href = "#";
        container.onclick = function (e) {
          e.preventDefault();
          toggleSensors();
        };
        return container;
      }
    });

    map.addControl(new LocationControl());
    map.addControl(new RecenterControl());
    map.addControl(new SensorControl());
  </script>
</body>
</html>
